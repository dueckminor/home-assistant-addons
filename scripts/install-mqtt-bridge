#!/usr/bin/env bash

set -eou pipefail
ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}" )/.." && pwd )"
cd "${ROOT_DIR}"

HOMEASSISTANT=homeassistant.local
if [[ -f "${ROOT_DIR}/gen/ha.txt" ]]; then
    HOMEASSISTANT=$(cat "${ROOT_DIR}/gen/ha.txt")
fi

if [[ "$(uname -s)" != "Darwin" ]] && [[ ! -d /addons ]]; then
    echo "This command has to be executed on home-assistant"
    exit 1
fi

# prepare ./gen/addons/mqtt-bridge

mkdir -p "${ROOT_DIR}/gen/addons/mqtt-bridge"
rm -rf "${ROOT_DIR}/gen/addons/mqtt-bridge/"*

pushd web/mqtt-bridge
npm run build
popd

# Build binaries for all platforms (for platform selector)
CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o ./addons/mqtt-bridge/mqtt-bridge-amd64 go/tools/mqtt-bridge/mqtt-bridge.go
CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -o ./addons/mqtt-bridge/mqtt-bridge-arm64 go/tools/mqtt-bridge/mqtt-bridge.go

cp -a ./addons/mqtt-bridge/* gen/addons/mqtt-bridge/

# Generate local build.yml for source-based builds
cat > gen/addons/mqtt-bridge/build.yml << 'EOF'
# Local development build configuration
build_from:
  aarch64: "ghcr.io/hassio-addons/base:16.3.6"
  amd64: "ghcr.io/hassio-addons/base:16.3.6"
  armhf: "ghcr.io/hassio-addons/base:16.3.6"
  armv7: "ghcr.io/hassio-addons/base:16.3.6"
  i386: "ghcr.io/hassio-addons/base:16.3.6"
EOF

# copy files to /addons/dueckminor_mqtt_bridge on homeassistant.local

(cd gen/addons/mqtt-bridge; tar czf - .) | (
if [[ "$(uname -s)" == "Darwin" ]]; then
    ssh "hassio@${HOMEASSISTANT}" '
        sudo rm -rf /addons/dueckminor_mqtt_bridge/
        sudo mkdir /addons/dueckminor_mqtt_bridge
        cd /addons/dueckminor_mqtt_bridge
        sudo tar xzvf -
        sudo chown -R "root:root" .
    '
else
    rm -rf /addons/dueckminor_mqtt_bridge/
    mkdir /addons/dueckminor_mqtt_bridge
    cd /addons/dueckminor_mqtt_bridge
    tar xzvf -
fi
)
