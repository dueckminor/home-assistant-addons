#!/usr/bin/env bash

set -eou pipefail
ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}" )/.." && pwd )"
cd "${ROOT_DIR}"

HOMEASSISTANT=homeassistant.local
if [[ -f "${ROOT_DIR}/gen/ha.txt" ]]; then
    HOMEASSISTANT=$(cat "${ROOT_DIR}/gen/ha.txt")
fi

if [[ "$(uname -s)" != "Darwin" ]] && [[ ! -d /addons ]]; then
    echo "This command has to be executed on home-assistant"
    exit 1
fi

mkdir -p gen/addons/gateway
rm -rf gen/addons/gateway/*

pushd web/auth
npm run build
popd

pushd web/gatewayconfig
npm run build
popd

# Build binaries for all platforms (for platform selector)
CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o ./addons/gateway/gateway-amd64 go/tools/gateway/gateway.go
CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -o ./addons/gateway/gateway-arm64 go/tools/gateway/gateway.go

cp -a ./addons/gateway/* gen/addons/gateway/

# Generate local build.yml for source-based builds
cat > gen/addons/gateway/build.yml << 'EOF'
# Local development build configuration
build_from:
  aarch64: "ghcr.io/hassio-addons/base:16.3.6"
  amd64: "ghcr.io/hassio-addons/base:16.3.6"
  armhf: "ghcr.io/hassio-addons/base:16.3.6"
  armv7: "ghcr.io/hassio-addons/base:16.3.6"
  i386: "ghcr.io/hassio-addons/base:16.3.6"
EOF

# copy files to /addons/dueckminor_gateway on homeassistant.local

(cd gen/addons/gateway; tar czf - .) | (
if [[ "$(uname -s)" == "Darwin" ]]; then
    ssh "hassio@${HOMEASSISTANT}" '
        sudo rm -rf /addons/dueckminor_gateway/
        sudo mkdir /addons/dueckminor_gateway
        cd /addons/dueckminor_gateway
        sudo tar xzvf -
        sudo chown -R "root:root" .
    '
else
    rm -rf /addons/dueckminor_gateway/
    mkdir /addons/dueckminor_gateway
    cd /addons/dueckminor_gateway
    tar xzvf -
fi
)
