#!/usr/bin/env bash

set -e

if [[ "$(uname -s)" != "Darwin" ]] && [[ ! -d /addons ]]; then
    echo "This command has to be executed on home-assistant"
    exit 1
fi

# prepare ./gen/addons/gateway

mkdir -p gen/addons/gateway
rm -rf gen/addons/gateway/*

# Build binaries for all platforms (for platform selector)
CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o gen/addons/gateway/gateway-amd64 go/tools/gateway/gateway.go
CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -o gen/addons/gateway/gateway-arm64 go/tools/gateway/gateway.go

cp -a ./addons/gateway/* gen/addons/gateway/

# Generate local build.yml for source-based builds
cat > gen/addons/gateway/build.yml << 'EOF'
# Local development build configuration
build_from:
  aarch64: "ghcr.io/hassio-addons/base:16.3.6"
  amd64: "ghcr.io/hassio-addons/base:16.3.6"
  armhf: "ghcr.io/hassio-addons/base:16.3.6"
  armv7: "ghcr.io/hassio-addons/base:16.3.6"
  i386: "ghcr.io/hassio-addons/base:16.3.6"
EOF

pushd web/auth
npm run build
popd
cp -a ./web/auth/dist gen/addons/gateway/

# copy files to /addons/dueckminor_gateway on homeassistant.local

(cd gen/addons/gateway; tar czf - .) | (
if [[ "$(uname -s)" == "Darwin" ]]; then
    ssh hassio@homeassistant.local '
        sudo rm -rf /addons/dueckminor_gateway/
        sudo mkdir /addons/dueckminor_gateway
        cd /addons/dueckminor_gateway
        sudo tar xzvf -
        sudo chown -R "root:root" .
    '
else
    rm -rf /addons/dueckminor_gateway/
    mkdir /addons/dueckminor_gateway
    cd /addons/dueckminor_gateway
    tar xzvf -
fi
)
