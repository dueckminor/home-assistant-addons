#!/bin/bash
# Script to extract a value from Home Assistant's secrets.yaml

set -e

HOSTNAME=ha.rh94.dueckminor.de

KEY_NAME=${1:-}
if [ -z "$KEY_NAME" ]; then
    echo "Usage: $0 <key_name>"
    echo "Example: $0 mqtt_password"
    exit 1
fi

echo "Extracting '$KEY_NAME' from Home Assistant secrets.yaml..." >& 2

# Method 1: Try yq first (most accurate)
VALUE=$(ssh hassio@$HOSTNAME "yq '.$KEY_NAME' /config/secrets.yaml 2>/dev/null" || echo "")

# Method 2: Fallback to Python if yq fails
if [ -z "$VALUE" ] || [ "$VALUE" = "null" ]; then
    VALUE=$(ssh hassio@$HOSTNAME "python3 -c \"
import yaml
try:
    with open('/config/secrets.yaml', 'r') as f:
        data = yaml.safe_load(f)
        print(data.get('$KEY_NAME', ''))
except Exception as e:
    print('')
\"" 2>/dev/null)
fi

# Method 3: Last resort - grep/sed for simple cases
if [ -z "$VALUE" ]; then
    VALUE=$(ssh hassio@homeassistant.local "grep '^$KEY_NAME:' /config/secrets.yaml | sed 's/^$KEY_NAME: *//' | sed 's/[\"\x27]//g'" 2>/dev/null || echo "")
fi

if [ -n "$VALUE" ] && [ "$VALUE" != "null" ]; then
    echo "$VALUE"
else
    echo "Error: Key '$KEY_NAME' not found in secrets.yaml" >&2
    exit 1
fi