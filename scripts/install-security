#!/usr/bin/env bash

set -eou pipefail
ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}" )/.." && pwd )"
cd "${ROOT_DIR}"

HOMEASSISTANT=homeassistant.local
if [[ -f "${ROOT_DIR}/gen/ha.txt" ]]; then
    HOMEASSISTANT=$(cat "${ROOT_DIR}/gen/ha.txt")
fi

if [[ "$(uname -s)" != "Darwin" ]] && [[ ! -d /addons ]]; then
    echo "This command has to be executed on home-assistant"
    exit 1
fi

mkdir -p gen/addons/security
rm -rf gen/addons/security/*

pushd web/security
npm run build
popd

# Build binaries for all platforms (for platform selector)
CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o ./addons/security/security-amd64 go/tools/security/security.go
CGO_ENABLED=0 GOOS=linux GOARCH=arm64 go build -o ./addons/security/security-arm64 go/tools/security/security.go

cp -a ./addons/security/* gen/addons/security/

# Generate local build.yml for source-based builds
cat > gen/addons/security/build.yml << 'EOF'
# Local development build configuration
build_from:
  aarch64: "ghcr.io/hassio-addons/base:16.3.6"
  amd64: "ghcr.io/hassio-addons/base:16.3.6"
EOF

# copy files to /addons/dueckminor_security on homeassistant.local

(cd gen/addons/security; tar czf - .) | (
if [[ "$(uname -s)" == "Darwin" ]]; then
    ssh "hassio@${HOMEASSISTANT}" '
        sudo rm -rf /addons/dueckminor_security/
        sudo mkdir /addons/dueckminor_security
        cd /addons/dueckminor_security
        sudo tar xzvf -
        sudo chown -R "root:root" .
    '
else
    rm -rf /addons/dueckminor_security/
    mkdir /addons/dueckminor_security
    cd /addons/dueckminor_security
    tar xzvf -
fi
)
